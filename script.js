// =========================================================
// 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
// =========================================================
const correctSound = new Audio('Sound/congratulations-male-spoken-264675.mp3'); 
const incorrectSound = new Audio('Sound/quotmm-mm-mmquot-male-voice-sfx-426969.mp3');
const finalSound = new Audio('Sound/jesse-andrews-sound-39595.mp3');

let isProcessing = false; 

const PENALTY_STAGES = 3; 

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
let score = 0;
let currentStreak = 0;
let maxStreak = 0;

const correctChoices = {
    // I. Cryptography & Logic
    1: 'B', 2: 'C', 3: 'A', 4: 'A', 5: 'C', 
    // II. User Protection
    6: 'B', 7: 'A', 8: 'C', 9: 'A', 10: 'B',
    // III. System & Network
    11: 'C', 12: 'A', 13: 'C', 14: 'B', 15: 'A',
    // IV. Data Management
    16: 'B', 17: 'A', 18: 'C', 19: 'B', 20: 'A',
    // V. GRC & Risk Management
    21: 'C', 22: 'B', 23: 'A', 24: 'B', 25: 'C'
};

// =========================================================
// üéØ 2. ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡πà‡∏≤‡∏ô (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î) üéØ
// =========================================================
const hints = {
    1: '‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á 2^6 (64) ‡πÅ‡∏•‡∏∞ 2^4 (16) ‡πÉ‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ê‡∏≤‡∏ô‡∏™‡∏≠‡∏á',
    2: '‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ A ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏¥‡∏ö‡∏´‡∏Å‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 10 ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏¥‡∏ö',
    3: '‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 65 (A)',
    4: 'OR ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ Input ‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
    5: 'XOR ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 1 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Input ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
    
    6: '‡∏°‡∏≠‡∏á‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏Å‡∏î "‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô" ‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á (Typosquatting)',
    7: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà, ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç, ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå',
    8: '‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏≠‡∏Å‡∏•‡∏ß‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£?',
    9: 'MFA ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà',
    10: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á Ransomware ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏£‡πà‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏±‡πâ‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ô‡∏µ‡πâ',

    11: '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô "‡∏Å‡∏≥‡πÅ‡∏û‡∏á" ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢',
    12: 'Private IP Class C ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 192.168.',
    13: 'HTTP ‡πÉ‡∏ä‡πâ Port ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ HTTPS (443)',
    14: '‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥',
    15: 'VPN ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà "‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß" ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ "‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞"',

    16: '‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå * ‡πÉ‡∏ô SQL ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"',
    17: '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á',
    18: '‡∏Å‡∏é 3-2-1 ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢',
    19: '‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•" ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏´‡∏•‡∏±‡∏Å',
    20: '‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ß‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô',
    
    21: '‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå) ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏´‡∏ô',
    22: '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ" ‡πÑ‡∏î‡πâ',
    23: '‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ "‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå" ‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢',
    24: '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î',
    25: '‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á" ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡πâ‡∏ô',
};

// =========================================================
// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏î‡πà‡∏≤‡∏ô
// =========================================================

function checkChoice(stageNumber, chosenAnswer) {
    if (isProcessing) return; 
    isProcessing = true; 

    const feedbackElement = document.getElementById(`feedback-${stageNumber}`);
    const currentStageElement = document.getElementById(`stage-${stageNumber}`);
    
    // Disable ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏Ç‡∏ì‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
    const choiceArea = currentStageElement.querySelector('.choice-area');
    choiceArea.querySelectorAll('button').forEach(btn => btn.disabled = true);

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏£‡∏£‡∏Å‡∏∞
    if (chosenAnswer === correctChoices[stageNumber]) {
        // --- üü¢ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞ Streak ---
        score += 100; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        currentStreak += 1; // ‡πÄ‡∏û‡∏¥‡πà‡∏° streak ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        maxStreak = Math.max(maxStreak, currentStreak); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
        updateStatsDisplay();

        // --- ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å: ‡πÑ‡∏õ‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ---
        correctSound.play(); 
        feedbackElement.textContent = "‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
        feedbackElement.className = 'feedback-message correct';
        
        setTimeout(() => {
            goToNextStage(stageNumber);
            isProcessing = false;
        }, 1500);
        
    } else {
        // --- üî¥ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Streak ‡πÅ‡∏•‡∏∞‡∏ö‡∏ó‡∏•‡∏á‡πÇ‡∏ó‡∏© "‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö X ‡∏î‡πà‡∏≤‡∏ô" ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ ---
        currentStreak = 0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï streak
        updateStatsDisplay();

        incorrectSound.play(); 
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ
        feedbackElement.textContent = `üí° ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ: ${hints[stageNumber]} | ‚ö†Ô∏è ERROR: ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö ${PENALTY_STAGES} ‡∏î‡πà‡∏≤‡∏ô...`;
        feedbackElement.className = 'feedback-message incorrect';
        
        // ‡∏ö‡∏ó‡∏•‡∏á‡πÇ‡∏ó‡∏©: ‡∏£‡∏≠ 7 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö (‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ)
        setTimeout(() => {
            applyPenalty(stageNumber);
            isProcessing = false;
        }, 7000);
    }
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å)
 */
function goToNextStage(currentStage) {
    const currentStageElement = document.getElementById(`stage-${currentStage}`);
    const nextStage = currentStage + 1;
    const nextStageElement = document.getElementById(`stage-${nextStage}`);
    
    if (currentStageElement) {
        currentStageElement.style.display = 'none';
        document.getElementById(`feedback-${currentStage}`).textContent = ''; 
    }

    if (nextStageElement) {
        nextStageElement.style.display = 'block';
        nextStageElement.querySelectorAll('button').forEach(btn => btn.disabled = false);
    } else {
        finalSound.play(); 
        document.getElementById('stage-final').style.display = 'block';
    }
}

/**
 * ‚ö°Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏ó‡∏•‡∏á‡πÇ‡∏ó‡∏©: ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö X ‡∏î‡πà‡∏≤‡∏ô ‚ö°Ô∏è
 * @param {number} currentStage - ‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏≥‡∏ú‡∏¥‡∏î
 */
function applyPenalty(currentStage) {
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏î‡∏ô‡∏ö‡∏ó‡∏•‡∏á‡πÇ‡∏ó‡∏©
    score = 0;
    currentStreak = 0;
    updateStatsDisplay();

    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 1)
    const targetStage = Math.max(1, currentStage - PENALTY_STAGES); 

    // 2. ‡∏ã‡πà‡∏≠‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ú‡∏¥‡∏î)
    const currentStageElement = document.getElementById(`stage-${currentStage}`);
    if (currentStageElement) {
        currentStageElement.style.display = 'none';
        document.getElementById(`feedback-${currentStage}`).textContent = '';
    }

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏î‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
    const targetStageElement = document.getElementById(`stage-${targetStage}`);
    if (targetStageElement) {
        targetStageElement.style.display = 'block';
        
        // 4. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Feedback ‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        const feedbackTarget = document.getElementById(`feedback-${targetStage}`);
        feedbackTarget.textContent = `üö® ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${targetStage}! ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö`;
        feedbackTarget.className = 'feedback-message incorrect';

        // 5. ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏î‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        targetStageElement.querySelectorAll('button').forEach(btn => btn.disabled = false);

        // 6. ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
            feedbackTarget.textContent = "";
            feedbackTarget.className = 'feedback-message';
        }, 3000);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏´‡∏≤‡∏Å element ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô DOM)
function updateStatsDisplay() {
    const scoreEl = document.getElementById('current-score');
    const streakEl = document.getElementById('highest-streak');

    if (scoreEl) scoreEl.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`;
    if (streakEl) streakEl.textContent = `‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô: ${maxStreak}`;
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° BGM ‡πÅ‡∏ö‡∏ö‡∏•‡∏π‡∏õ
const bgAudio = new Audio('Sound/cyberpunk-beat-64649.mp3');
bgAudio.loop = true;
bgAudio.volume = 0.18;

let bgPlaying = false;
let bgInitListener = null;

// ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (gesture) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á autoplay block
function startBgOnFirstGesture() {
    if (bgPlaying) return;
    bgAudio.play().then(() => {
        bgPlaying = true;
        updateBgButton();
    }).catch(() => {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (autoplay blocked) ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° toggle ‡πÄ‡∏≠‡∏á
    });
    // ‡∏•‡∏ö listener ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    if (bgInitListener) {
        document.removeEventListener(bgInitListener.type, bgInitListener.fn);
        bgInitListener = null;
    }
}

// ‡∏ï‡∏±‡πâ‡∏á listener ‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å/‡πÅ‡∏ï‡∏∞/keydown)
bgInitListener = { type: 'click', fn: startBgOnFirstGesture };
document.addEventListener('click', bgInitListener.fn, { once: true });
document.addEventListener('keydown', startBgOnFirstGesture, { once: true });
document.addEventListener('touchstart', startBgOnFirstGesture, { once: true });

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° BGM
function toggleBg() {
    if (bgPlaying) {
        bgAudio.pause();
        bgPlaying = false;
    } else {
        bgAudio.play().then(() => { bgPlaying = true; }).catch(() => { /* ignore */ });
    }
    updateBgButton();
}

function updateBgButton() {
    const btn = document.getElementById('bg-toggle');
    if (!btn) return;
    btn.textContent = bgPlaying ? 'üîä BGM: ON' : 'üîà BGM: OFF';
}
// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î
window.addEventListener('load', updateBgButton);

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
window.addEventListener('load', updateStatsDisplay);